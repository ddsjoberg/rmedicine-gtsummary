<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Reproducibility with {gtsummary}</title>
    <meta charset="utf-8" />
    <meta name="author" content="Daniel D. Sjoberg, Karissa Whiting" />
    <meta name="date" content="2020-08-28" />
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
    <link rel="stylesheet" href="my-theme.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">




class: inverse, center, title-slide, middle

# Reproducibility with {gtsummary}

### Daniel D. Sjoberg, Karissa Whiting

### August 28, 2020
### R/Medicine  

&lt;p align="center"&gt;&lt;img src="images/msk-white-logo.png" width=25%&gt;&lt;/p&gt;
   
#### bit.ly/rmed-gtsummary
 
---

# the problem: (ir)reproducibility

.pull-left[.large[
- Quality of medical research is often low

- Quality of code for medical research is low/non-existent

- Low quality code is more likely to contain errors

- Reproducibility is often **cumbersome** and **time-consuming**
]]

.pull-right[
&lt;p align="center"&gt;&lt;img src="images/reproducibility-graphic-online1.jpeg" width=90%&gt;&lt;/p&gt;
]


???

- reproducibility in medical research is a long-reported problem, and the code is an important part of this

- Doug Altman noted the quality of medical research in 1994 and called in a scandal

- I don't need to explain this to the people here though! One of the big themes of this year's conference is reproducibility

- Nature also reported the the reproducibility crisis in 2016

- At European Urology we asked authors to submit their code.
    - one-third of papers with nontrivial statistics indicated they did not use code
    - no submitted code satisfied the three basic principles of good software
    
- Nice output is HARD, and often takes a lot of custom coding and time. In a pinch, it's easier to not follow best practices.


---
# gtsummary: (a part of) the solution
&lt;p align="center"&gt;&lt;img src="images/gtsummary-HexSticker.png" width=50%&gt;&lt;/p&gt;


???
- Wanted to create package geared towards medical research that made creating the most common tables as simple as possible
    - But also very flexible
    - Most packages for R use APA formatting...not helpful for medical journals (also, life, but that is just my opinion!)

---
# gtsummary: (a part of) the solution

### Types of summaries:
.center[
.xlarge[
.pull-left[
**"Table 1"-type tables**

**Cross tabulation**
]

.pull-right[
**Regression models**

**Survival data**
]
]

&lt;br&gt;
.large[
_**Stack** and/or **merge** any of these tables_

_Report statistics from tables **in-line**_

_**Themes** to control aspects of all tables_

_Choices on **print engine**_
]
]

???

Support for the 

---

class: inverse, center, middle

# summarize data with tbl_summary()

---
# summarize data with tbl_summary()

.large[**Example: Summarizing clinical study data**]

.pull-left[
.large[

**Goal**: Summarize data by treatment groups:
- Age
- Tumor Response
- Tumor Grade
]

```r
library(gtsummary)
library(tidyverse)

sm_trial &lt;-
  trial %&gt;%
  select(trt, age, grade, response)
```



]
.pull-right[
&lt;p align="center"&gt;&lt;img src="images/gt_trial_info.png" width=90%&gt;&lt;/p&gt;
]

???
- This is an abbreviated version of the example data used in the package help files/documentation. 

- note that the column have been labeled using the {labelled} package, and those are used throughout the package

---
# summarize data with tbl_summary()
.pull-left[
.large[
**basic tbl_summary()**
]


```r
tbl_summary_1 &lt;- 
  sm_trial %&gt;%
  tbl_summary(by = trt)
```

.medium[
- Three types of summaries: `continuous`, `categorical`, and `dichotomous`

- Default statistics are `median (IQR)` for continuous variables, and `n (%)` for categorical/dichotomous data

- Variables coded as `0/1`, `TRUE/FALSE`, and `Yes/No` are presented dichotomously by default
]
]
.pull-right[
&lt;p align="center"&gt;&lt;img src="images/tbl_summary_1.png" width=85%&gt;&lt;/p&gt;
]

???
- Go slow here

- summarizing a data set is the MOST important analysis

- summarize data first!  you will often catch mistakes.  Data is complicated, and understanding it up front is important.

- Communicating a summary of the data ALONG with analytic results in necessary (others may catch mistakes you're not aware of)

- {gtsummary} is for presenting results, other great packages are available for summarizing data for your self (e.g. skimr)

- just one line of code

- all functions beginning with `tbl_*` create a new tables

- this is how I used the package 95% percent of the time...so easy

- three types of data shown here (explain them)

---
# summarize data with tbl_summary()

.pull-left[
.large[
**customize with arguments**
]


```r
tbl_summary_2 &lt;- 
  sm_trial %&gt;%
  tbl_summary(
    by = trt,
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} / {N} ({p}%)"), 
    label = age ~ "Patient Age",
    digits = age ~ 2,
    missing_text = "N Unknown")
```


.medium[
- `statistic` Report mean and standard deviation for continuous variables
- `label` Specify label for age
- `digits` Specify number of decimals to round to
- `missing_text` Text to appear for N missing
]
]
.pull-right[
&lt;p align="center"&gt;&lt;img src="images/tbl_summary_2.png" width=95%&gt;&lt;/p&gt;
]

???

- defaults are great, let's change the default behavior

- statistics can be changed to anything...literally any R function (e.g. variance)

- discuss the formula notation
    - it's like `case_when()`, condition/variable on LHS and result on RHS
    - one formula doesn't need to be in a list, but more than one must be listed

- the vignette has examples with more examples

---
background-image: url(images/Dan-tbl_summary_small_example.png)
background-position: center
background-size: cover

---
# {gtsummary} and formulas
.large[

Many arguments use formula syntax (or list of formulas), and provide many  options to easily select variables you want to modify.   
&lt;br&gt;
&lt;br&gt;

.center[

**_select variables_ ~ specify what you want to do** 
]



- `label = list(age ~ "Patient Age", marker ~ "Marker Level Pre-Tx")`
- `type = c(age, marker) ~ "continuous"`
- `digits = list(age ~ 0, marker ~ 2)`
- `statistic = all_continuous() ~ "{median} [{min}, {max}]"`

]

???
- case_when uses similar syntax 


---
# tbl_summary() + helper functions

.large[
`tbl_summary()` objects can also be updated using related functions.

- `add_*()` add additional column of statistics or information, e.g. p-values, q-values, overall statistics, N obs., and more

- `modify_*()` modify table headers, spanning headers, and footnotes

- `bold_*()/italicize_*()` style labels, variable levels, significant p-values

]

???
The modify functions and the bold functions work on ALLL gtsummary tables


---
background-image: url(images/Dan-tbl_summary_big_example.png)
background-position: center
background-size: cover

---
background-image: url(images/tbl_summary_demo_fast.gif)
background-position: center
background-size: contain

# tbl_summary() in action

---
# cross table with tbl_cross()

`tbl_cross()` is a wrapper for `tbl_summary()` for **2 x 2** tables

.pull-left[
&lt;br&gt;

```r
tbl_cross_1 &lt;-
  sm_trial %&gt;%
  tbl_cross(
    row = trt, 
    col = grade,
    percent = "row",
    margin = "row"
  ) %&gt;%
  add_p(source_note = TRUE)
```

]

.pull-right[
&lt;p align="center"&gt;&lt;img src="images/tbl_cross_1.png" width=90%&gt;&lt;/p&gt;
]

---

class: inverse, center, middle

# Summarizing Regression Models with
# tbl_regression()

---
# summarize models with tbl_regression()

.large[
**Goal**: Summarize a logistic regression model predicting tumor response
]
.pull-left[



```r
library(gtsummary)
library(tidyverse)

m1 = glm(response ~ age + stage,
         data = trial,
         family = binomial(link = "logit"))
```

.large[
- Display Odds Ratio estimates and CI's for all covariates
- Display p-values for covariates
- Show reference levels for categorical variables
]

]



.pull-right[
&lt;p align="center"&gt;&lt;img src="images/tbl_logreg.png" width=80%&gt;&lt;/p&gt;
]


---
# summarize models with tbl_regression()

.large[
**Basic tbl_regression() code**
]

.pull-left[


```r
m1 = glm(response ~ age + stage,
         data = trial,
         family = binomial(link = "logit"))
tbl_logreg &lt;- 
  tbl_regression(m1, exponentiate = TRUE)
```


.medium[
- Variable types are automatically detected and reference rows are created for categorical variables.

- Variable labels are carried through into the output table (if no labels, variable names are used). 

- The model was recognized as logistic regression with coefficients exponentiated, so the header displayed “OR” for odds ratio.
]
]
.pull-right[
&lt;p align="center"&gt;&lt;img src="images/tbl_logreg.png" width=70%&gt;&lt;/p&gt;
]

???
- Model estimates and confidence intervals are rounded and nicely formatted.

- P-values above 0.9 are presented as “&gt;0.9” and below 0.001 are presented as “&lt;0.001”. Non-significant p-values are only rounded to one decimal, while those close to or below the significance threshold (default 0.05) have additional decimal places by default.

- Variable levels are indented and footnotes are added if printed using {gt}. (can alternatively be printed using knitr::kable(); see options here)


---
# summarize models with tbl_regression()
.large[
**Customize Regression Tables**
]
.pull-left[


```r
tbl_logreg2 &lt;-
  tbl_regression(m1,
    exponentiate = TRUE,
    label = vars(age) ~ "Age, yrs",
    pvalue_fun = function(x) {
      style_pvalue(x, digits = 2)
    }
  ) %&gt;%
  bold_labels() %&gt;%
  italicize_levels() %&gt;%
  add_global_p() %&gt;%
  bold_p(t = .1)
```


.medium[
- `exponentiate` - Exponentiate model coefficients to display ORs
- `label` - Specify label for age
- `pvalue_fun` - Round and format p-values
- `add_global_p()` - Calculate global p-values for categorical variables
- `bold_p()` - Bold p-values under threshold of .1
]
]

.pull-right[
&lt;p align="center"&gt;&lt;img src="images/tbl_logreg2.png" width=80%&gt;&lt;/p&gt;
]

???
- use arguments and helper functions to customize


---
background-image: url(images/tbl_regression_markup.png)
background-position: center
background-size: contain

---

# tbl_uvregression() Univariate Summaries
.large[
**Basic tbl_uvregression() code**
]

.pull-left[



```r
tbl_uvreg &lt;- 
  trial %&gt;% 
  select(age, stage, grade, response) %&gt;%
  tbl_uvregression(
    method = glm,
    y = response,
    method.args = list(family = binomial),
    exponentiate = TRUE)
```


.medium[
- Specify which model method to use, any necessary method arguments, and the response variable

- Arguments and helper functions like `exponentiate`, `bold_*()`, `add_global_p()` are also available for `tbl_uvregression()`

]
]
.pull-right[
&lt;p align="center"&gt;&lt;img src="images/tbl_uvreg.png" width=70%&gt;&lt;/p&gt;
]

???
- OR was recognized due to exponentiate arg


---

# inline_text()

-TBD


---

class: inverse, center, middle

# Advanced Customization with Themes

---
# {gtsummary} + Themes

.large[**Theme Basics**]

.large[
- A theme is a defined set of customization preferences that can be easily set and reused. 

- Themes can control default function behaviors (e.g. Always present mean instead of median for continuous variables in `tbl_summary()`)

- Themes can also control more fine-grained customization not available via arguments or helper functions (e.g. set packagewide language preference)

- Easily set one of the available package themes, or create your own personalized theme!

]


---
# {gtsummary} + Themes

.large[**Available Themes**]




.pull-left[
.large[

- Use `theme_gtsummary_jornal()` to format to specific publication guidelines.

- Use `theme_gtsummary_language()` to translate tables

- Use `theme_gtsummary_compact()` to reduce default padding and font size of tables

]
]


.pull-right[
&lt;p align="center"&gt;&lt;img src="images/themes.gif" width=100%&gt;&lt;/p&gt;
]

???
- journal theme- for example, large p-values are rounded to two decimal places, IQR sep with dash rather than comma, percent symbol removed. RIght now we have JAMA and lancet, but will likely expand options in the future

- language theme - Currently 12 different languages available and looking to expand

- Any of these can be layered, for example you can use compact and language together. and you only have to set once a session. 

---
# {gtsummary} + Themes

.large[**Create Your Own Theme**]

.pull-left[
.medium[

- A theme is just a named list of customization elements (glossary of available theme element options in docs)
- A few examples of what you can customize with themes:
    - Always style p-values, to X number of digits
    - Set default statistical tests to use (e.g. always use `fisher.test` for categorical)
    - Specify large number separator (e.g. 1.000 vs. 1,000)
    - Always sort categorical variables by frequency
    - And MANY MORE!

]
]

.pull-right[
.large[


```r
karissa_theme &lt;-   
  list(
    # round large p-values to two places
    "pkgwide-fn:pvalue_fun" = function(x) style_pvalue(x, digits = 2),
    "add_p.tbl_summary-attr:test.categorical" = "fisher.test", 
    # report median (IQR) and n (percent) as default stats in `tbl_summary()`
    "style_number-arg:big.mark" = ".",
    "tbl_summary-arg:sort" = all_categorical() ~ "frequency"
  )

set_gtsummary_theme("karissa_theme")
```


]
]






---

class: inverse, center, middle

# Printing {gtsummary} Tables 

---
# {gtsummary} + R Markdown

.left-column[ 
.large[
{gtsummary} tables are compatible with most R Markdown outputs and tables can be printed using a number of print methods. 
]
]
.right-column[ 
&lt;p align="center"&gt;&lt;img src="images/print-eng-table.png" width=80%&gt;&lt;/p&gt;
]

---
# {gtsummary} + R Markdown

.large[
- {gtsummary} has sensible print engine defaults to help chose the print engine most suited your output format. 

- These defaults can be easily overridden using any of the conversion functions like `as_gt()`, `as_flex_table()`, etc.

]



&lt;p align="center"&gt;&lt;img src="images/print_engine_defaults.png" width=35%&gt;&lt;/p&gt;

---

class: inverse, center, middle

# Thank You

---

# code example 1


```r
trial %&gt;%
  select(age, grade, trt) %&gt;%
  tbl_summary(
    # stratify table by treatment
    by = trt,
    # show mean and SD for age, and add denom for grade
    statistic = list(age ~ "{mean} ({sd})",
                     grade ~ "{n} / {N} ({p}%)"),
    # update label for grade
    label = grade ~ "Tumor Grade",
    # updated text for missing values
    missing_text = "N Unknown"
  )
```

---
background-image: url(images/Dan-tbl_summary_small_example.png)
background-position: center
background-size: cover

---
# example code 2


```r
# summarize variables by treatment received
trial %&gt;%
  select(age, grade, trt) %&gt;%
  tbl_summary(by = trt) %&gt;%
  # add a column with statistics not stratified by treatment
  add_overall() %&gt;%
  # compare values across treatments
  add_p() %&gt;%
  # add a column with number of non-missing observations
  add_n() %&gt;%
  # bold the variable labels
  bold_labels() %&gt;%
  # add a header over the treatment columns
  modify_spanning_header(c(stat_1, stat_2) ~ "**Treatment Received**") %&gt;%
  # update the column header
  modify_header(label ~ "**Variable**") %&gt;%
  # udpate the default footnote for the statistics presented
  modify_footnote(starts_with("stat_") ~ "Median (IQR) or Frequency (%)")
```

---
background-image: url(images/Dan-tbl_summary_big_example.png)
background-position: center
background-size: cover
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"ratio": "16:9"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
